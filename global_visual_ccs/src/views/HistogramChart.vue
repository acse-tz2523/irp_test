<!--
Author: Tianzi Zhang
GitHub: acse-tz2523
-->
<template>
  <div>
    <div class="scenario-selection">
      <el-checkbox-group v-model="selectedScenarios" @change="fetchData">
        <el-checkbox label="R_S1">Reference Scenario</el-checkbox>
        <el-checkbox label="R_S2">Minimum Scenario</el-checkbox>
        <el-checkbox label="R_S3">Maximum Scenario</el-checkbox>
        <el-checkbox label="R_S4">Increase by 10%</el-checkbox>
        <el-checkbox label="US1Gt">US1Gt</el-checkbox>
        <el-checkbox label="EUUSChina">EUUSChina</el-checkbox>
      </el-checkbox-group>
      <el-checkbox v-model="allScenarios" @change="changeAll">All</el-checkbox>
    </div>
    <div id="scatterPlot" style="height: 300px;"></div>
    <div id="histogramChart" style="height: 500px;"></div>
  </div>
</template>

<script>
import Plotly from 'plotly.js-dist';
import axios from 'axios';

export default {
  data() {
    return {
      allScenarios: false,
      selectedScenarios: [],
      ar6Data: {
        // Data for various scenarios
       
        "1.5\u2103:limited overshoot " : [2.072461, 2.1350067, 2.50643945314664, 2.995577379, 3.13662235998095, 3.6720279, 3.72291850331192, 3.83791998870618, 3.87230165292801, 3.963767841, 3.9710969, 3.98347853815138, 4.22571801831041, 4.93920857504176, 4.9520942, 5.1945239, 5.29657082725156, 5.306435, 5.31954279293079, 5.34777766052807, 5.373052, 5.42494327371785, 5.455684, 5.47983878318177, 5.48828389076059, 5.4923149, 5.51104497833745, 5.53598543846933, 5.59491264975764, 5.738376044, 5.86073735152244, 6.0043256, 6.014148, 6.138937, 6.16206443392442, 6.3097503, 6.50789697265625, 6.7310896, 6.85747619448649, 6.86212, 7.000748046875, 7.102454, 7.1618999, 7.18285209839308, 7.2222564, 7.35151537004674, 7.54217746978584, 7.63734521484375, 7.82777522, 8.145833, 8.1831525, 8.2755373, 8.4857328, 8.5575771, 8.574532, 8.60211, 8.6230969, 8.623574, 8.8669284, 9.4879522, 9.5285211, 9.536163, 10.11375, 10.3016367, 10.44396, 11.2408483, 11.6743784110748, 11.6927107, 12.0620789662705, 12.8, 13.0707759, 13.0722168, 14.0821194789276, 14.5238344434193, 14.7051146, 14.9261802, 14.9964302638702, 15.1012968, 16.9026115, 17.2048865572358, 17.4084154, 17.8783583557964, 18.0964666666667, 18.5307049122411, 19.2271565713083, 19.3298940924495, 21.8271741439874, 22.4123366060246, 22.9310806871995, 22.9579173654645, 23.153686299396, 23.4662497644423],
        "1.5\u2103:high overshoot" :  [1.01527563476563, 1.43449792480469, 1.54487719726563, 2.122576171875, 2.7638814, 2.90679065303395, 2.9728891, 2.99074764628783, 3.36770241560385, 3.46331739574943, 3.52834921355249, 3.58553041344323, 3.77513222567522, 3.7786796, 4.01314780594259, 4.10712306116925, 4.16762780691762, 4.44625420243438, 4.45352572131864, 4.495873, 4.52887867915652, 4.64090012638674, 4.72488618495988, 4.78948447453502, 4.79512642157395, 4.81672484641897, 4.88159255613537, 4.89861290950001, 4.94479637301519, 4.953988927144, 4.95928571854543, 4.98464268532543, 5.01853582139352, 5.05384693745297, 5.0720706, 5.07958439834466, 5.0964354, 5.1022689875016, 5.14648977120363, 5.21332870466763, 5.29591021472138, 5.44548744214996, 5.50158602643449, 5.5836506626533, 5.5987597, 5.6111442, 5.6336335, 5.65065043422632, 5.851793, 5.9314679, 5.97150275170018, 5.9814998, 6.3129799, 6.40412666666667, 6.489403637, 6.535799451, 6.707311, 6.7574564, 6.7946116, 6.812888857, 6.838464925, 6.955255, 6.9579714, 7.0495567, 7.053552, 7.407218, 7.407218, 7.503558, 7.577103, 7.588214, 7.657099, 7.685376, 7.685376, 7.8149057, 7.843688, 8.108041, 8.4155351, 8.5848287, 8.750489, 9.4, 9.958643137, 10.55856461, 10.7611153, 11.05198, 11.12612, 11.31318, 11.3874126, 11.79849, 12.2004915, 12.2195594634043, 12.4187445932378, 12.4482851, 12.458951, 12.8296109, 12.829696, 12.8757095, 12.9193510979818, 13.1618756, 13.6670622814255, 14.2515271276435, 14.6580081987222, 14.8300347175559, 14.848581160282, 15.0858774953443, 15.3894844726962, 15.7097025362036, 15.8205624336708, 16.2643890078235, 16.407567894957, 16.569097533994, 16.8, 17.1683169041918, 17.2314684785139, 17.5391259541114, 18.0209857967668, 18.1538196156422, 18.1777853942132, 18.2191543080051, 18.3680157893528, 18.5405523262227, 18.5957026871808, 18.965325015134, 19.2687022579345, 21.0451162799456, 21.4370043769544, 23.2986502610037, 24.1590617817748, 24.5194317174393, 25.4036838410544, 25.8177545243131],
        "2\u2103 > 67% likelihood" : [0.955175720214844, 0.986886962890625, 1.02760217285156, 1.02812719726562, 1.03245068359375, 1.04627770996094, 1.10071508789063, 1.1074990234375, 1.13721545410156, 1.1601171875, 1.23316076660156, 1.2459697265625, 1.32034399414062, 1.33654443359375, 1.3464287109375, 1.36663977050781, 1.78838427734375, 2.0510551, 2.4452908, 2.49931079101562, 2.51752416992188, 2.65466879907367, 2.8812253, 2.9321743, 3.01330792202069, 3.095819584, 3.22345433386772, 3.22955565771501, 3.2358169, 3.3007711, 3.3154416, 3.3322989459313, 3.3572026, 3.38334242887238, 3.41519308655818, 3.41877, 3.42966485538711, 3.44139998167084, 3.52171553832984, 3.53048813984123, 3.5457897146747, 3.5543851, 3.59246695949592, 3.6015808, 3.60971758452019, 3.62284044021011, 3.6228722, 3.62629342795944, 3.65133518909187, 3.66397705259426, 3.6705802, 3.67216944277172, 3.67266123521803, 3.68566283763583, 3.68710823642266, 3.69708950278115, 3.70305992860973, 3.7162771, 3.7283957, 3.73122958834822, 3.74211817619138, 3.7426409, 3.74841795081382, 3.75479463254605, 3.7577622781441, 3.7653076, 3.77850356836967, 3.8327998, 3.8334562, 3.83542587604148, 3.8500118, 3.85204724962196, 3.8538359, 3.85654102067209, 3.87152766791353, 3.87767266790169, 3.88018083162489, 3.92055656200869, 3.92835082366632, 3.93945956304365, 3.94794673448591, 4.03754264122905, 4.04785567583833, 4.08226399347506, 4.12366951202852, 4.1486481264515, 4.15439247908601, 4.16686567219196, 4.17141516487535, 4.18169094799298, 4.20460285873621, 4.23608465179892, 4.2451686, 4.2674845, 4.2874207, 4.29307677206973, 4.298355991, 4.31818800640575, 4.34092974652949, 4.3437513, 4.3699495, 4.40301362940627, 4.430776, 4.44317359083057, 4.45433788516486, 4.4574369, 4.4634558, 4.47014628803955, 4.50965399339382, 4.5128788956, 4.5215788, 4.53362245347302, 4.5406756, 4.5426396, 4.5451639701, 4.5538003, 4.55489373210513, 4.5806332, 4.585332496, 4.5865063, 4.58837346565247, 4.5883746, 4.5942462, 4.6328172, 4.66939470549412, 4.7103475, 4.71204442105604, 4.71880661090202, 4.74643037511431, 4.74955014769832, 4.7615836, 4.76346033091029, 4.79479437735498, 4.81004063196983, 4.83730973922973, 4.8472693, 4.89029102088605, 4.9042424, 4.9340388, 4.9748141, 4.9902136, 4.99480769331741, 5.00663303536804, 5.0158251, 5.0730202, 5.08, 5.08946625298595, 5.14422359908039, 5.1464403, 5.1539964, 5.1875535, 5.2353722, 5.26244246902283, 5.2729271, 5.277231, 5.27867117120553, 5.36236696380927, 5.37465662525101, 5.38138443656856, 5.3985074, 5.40058287438401, 5.42310954991032, 5.44343170749836, 5.44743500855892, 5.4823221, 5.5073923, 5.51157075173511, 5.51630092758274, 5.53290920676099, 5.54969938766201, 5.5669322, 5.6537687, 5.679116499, 5.68519337982415, 5.82682395018555, 5.88603067214108, 5.892776, 5.901443574, 5.93172043856292, 5.9696077, 5.9828627, 6.05687158824449, 6.1394777, 6.162713663, 6.2590495, 6.311795296, 6.3220869, 6.36991129474368, 6.3911867, 6.4419821, 6.469324082, 6.4844611, 6.50146844390568, 6.50902811422489, 6.661810546875, 6.79262598537271, 6.80672412109375, 6.85289599100912, 6.85511474609375, 6.955255, 7.0408687, 7.0489751, 7.084531345, 7.22454904354, 7.252482703, 7.3095724, 7.36614111328125, 7.4134965, 7.41648466903769, 7.46334498, 7.46625697288684, 7.46625697288684, 7.53705233140003, 7.67039984803467, 7.69998655227837, 7.8331949, 7.8522281, 7.9264595053518, 7.937078797, 7.9763788240452, 7.98209727628078, 7.99482722615292, 8.04953883, 8.16011952307307, 8.203379696, 8.233392112, 8.259507021, 8.275200618, 8.2968315, 8.55437266764541, 8.56225835186118, 8.66252, 8.8815326, 8.97841027776774, 8.99170841807028, 9.0112063, 9.05676908046007, 9.4112631, 9.41496593810368, 9.48529219212184, 9.53351031435035, 9.61043192446232, 9.83426398813456, 9.9054607174312, 9.92991315213587, 10.1292639, 10.1803158223629, 10.2097165, 10.2814050300513, 10.4296414662942, 10.5797218, 10.6884425055784, 10.753613, 10.9254705, 10.9646708, 11.0054596666667, 11.4012209034035, 11.5228574866195, 11.6198711742957, 11.7456155810505, 11.8506500700535, 11.8583053117958, 11.9899788, 12.0819536, 12.1107327, 12.2610317, 12.3647626, 12.3992451305191, 12.4076647647918, 12.4437478232042, 12.468103, 12.4707935, 12.6030894557967, 12.6660117934361, 12.8757095, 13.1058711, 13.1573363, 13.5529863, 13.565907, 13.7376065417765, 13.9962720923894, 14.0921862, 14.2682596418662, 14.2922095, 14.9552291482687, 15.1711170909305, 15.1885506666667, 15.296875068297, 15.5438353585815, 15.6126756730179, 15.797060482204, 16.0512510083615, 16.2292474609589, 16.3039830252528, 17.5146023856239, 18.1111923009784, 18.3205492645373, 19.3775924215418, 19.3910769390807, 19.5207953495645, 19.9950973915801, 20.1462600188741, 20.5006434438119, 22.9055993335467, 22.9229400383498, 23.1483504151361, 23.19891597608, 24.6272546666667, 30.0002145173227],
        "2\u2103 > 50% likelihood" :[1.04731762695313, 1.05037951660156, 1.06481896972656, 1.08706506347656, 1.20340307617188, 1.22360815429688, 1.30704211425781, 1.3244765625, 1.34090014648438, 1.35034106445313, 1.39891739113185, 1.4276272, 1.4276272, 1.43792407226563, 1.45755505371094, 1.49552111816406, 1.51172924804687, 1.51871911621094, 1.54775561523437, 1.6208363778136, 1.62089965820312, 1.65659826660156, 1.79481640625, 1.85727447498624, 1.86993614099236, 1.92979993042329, 1.93388851943018, 2.20359409083976, 2.2355479840895, 2.25148315429688, 2.3749150390625, 2.38522038804233, 2.437391, 2.437391, 2.48149305803653, 2.6, 2.6272368006725, 2.63786895128455, 2.63883939675583, 2.70255574835832, 2.70860308048699, 2.71516893966627, 2.76644614302059, 2.79686018219494, 2.80077192654069, 2.81011189038645, 2.82200889244816, 2.89460087977509, 2.9084099081283, 2.99366369069387, 3.05548095527316, 3.10617791119336, 3.11605551012922, 3.14886972592097, 3.1847431, 3.1847431, 3.19427756877527, 3.20446250417781, 3.20699641450907, 3.21863049644881, 3.23054647415409, 3.26797521579994, 3.33257454872563, 3.3899338685021, 3.4247221765296, 3.45849043453881, 3.5274541601812, 3.5900171619445, 3.742997016, 3.828987474, 3.86847877413666, 3.93344491418969, 3.97516930498098, 4.01088504619423, 4.05372387695312, 4.20770810291916, 4.262237611, 4.27251814939988, 4.27251814939988, 4.39007246248761, 4.550357744, 4.5892569091582, 4.651523278, 4.75405264705835, 4.75516535486268, 4.78574647386457, 4.81076789852, 4.8360401, 4.9694746608468, 4.97151335658816, 5.0471582, 5.05049276165664, 5.121261, 5.347636157, 5.46591, 5.495450962, 5.614702, 5.81198431873072, 5.816684, 5.992512072, 5.992512072, 6.079303216, 6.079303216, 6.13492908079689, 6.1862985, 6.2568039, 6.415613594, 6.469324082, 6.924075674, 7.06758559743563, 7.4606796357632, 7.909594, 8.13098451570869, 8.13625654166585, 8.46321680645148, 8.48645598221697, 8.705552246, 8.77461363499363, 9.2105206, 9.2707838, 9.384, 9.44759645147828, 9.93707210680304, 10.0630841, 10.1013415964941, 10.2485748, 10.2878511, 10.3518396, 10.4747813766201, 10.6161935903699, 10.621267, 10.6431448248217, 11.1144943, 11.1163656912445, 11.5886556667586, 12.0, 12.3643593333333, 12.4707095356037, 12.5221157320851, 12.6334807655464, 12.7286787503465, 13.0241019237262, 13.082892, 13.3262486537931, 13.4394331301252, 13.749818439285, 13.8246831989164, 14.0395235924245, 14.0728288702667, 14.8494613020058, 14.9183180253025, 15.5016987212002, 15.6027043333333, 21.857308],    
      
      }
    };
  },
  mounted() {
    this.fetchData();
  },
  methods: {
    /**
     * Handles the selection of the "All" checkbox. 
     * Selects or deselects all scenarios based on the checkbox value.
     * @param {boolean} val - The value of the "All" checkbox.
     */
    changeAll(val) {
      if (val) {
        this.selectedScenarios = ['R_S1', 'R_S2', 'R_S3', 'R_S4', 'US1Gt', 'EUUSChina'];
      } else {
        this.selectedScenarios = [];
      }
      this.fetchData();
    },

    /**
     * Fetches data for the selected scenarios and updates the plots.
     * Clears the plots if no scenarios are selected.
     */
    fetchData() {
      if (this.selectedScenarios.length === 6) {
        this.allScenarios = true;
      } else {
        this.allScenarios = false;
      }
      if (this.selectedScenarios.length === 0) {
        Plotly.purge('histogramChart');
        Plotly.purge('scatterPlot');
        return;
      }
      const requests = this.selectedScenarios.map(scenario =>
        axios.get(`http://localhost:8080/data/aggregate/sum/${scenario}`)
      );
      axios.all(requests).then(axios.spread((...responses) => {
        const data = responses.map(res => ({ scenario: res.data.scenario, data: res.data.total }));
        this.updateScatterPlot(data);
        this.updateHistogramChart(data);
      }));
    },

    /**
     * Updates the scatter plot with the fetched data.
     * Adds shapes to represent the data range and a box plot for the AR6 data.
     * @param {Array} data - The data to be plotted.
     */
    updateScatterPlot(data) {
      let shapes = []; // Stores the shapes for the rectangles representing data ranges
      let scatterData = []; // Stores the scatter plot data
      let boxData = []; // Stores the box plot data

      data.forEach(item => {
        const minValue = Math.min(...item.data);  // Extracts the minimum value
        const maxValue = Math.max(...item.data);  // Extracts the maximum value

        // Draws rectangles connecting the minimum and maximum values
        shapes.push({
          type: 'rect',
          x0: minValue,  // Rectangle start: minimum value
          x1: maxValue,  // Rectangle end: maximum value
          y0: 0.1,  // Controls the position of the rectangle on the Y-axis
          y1: 4.1,  // Controls the height of the rectangle
          fillcolor: this.getScenarioColor(item.scenario),
          opacity: 0.6,  // Set opacity
          line: {
            width: 0  // Hides the rectangle border line
          }
        });

        // Adds a scatter point for the legend (only one point, not displayed in the plot)
        scatterData.push({
          x: [minValue],  // Only one point is needed for the legend
          y: [null],  // Ensures the point is not displayed in the plot
          mode: 'markers',
          marker: {
            color: this.getScenarioColor(item.scenario),
          },
          name: item.scenario,
          showlegend: true  // Only display in the legend
        });
      });

      // Add horizontal box plots
      Object.keys(this.ar6Data).forEach((key) => {
        const scenarioData = this.ar6Data[key];
        boxData.push({
          x: scenarioData,
          type: 'box',
          orientation: 'h', // Horizontal display
          name: key,
          marker: {
            color: this.getScenarioColor(key),
          },
          boxmean: true
        });
      });

      const layout = {
        title: 'Scenario Data with Horizontal Box Plot',
        xaxis: {
          title: 'Total Storage Rate in 2050 [Gt/year]',
        },
        yaxis: {
          title: 'Year',
          type: 'category',
          tickvals: [1],
          ticktext: ['2050']
        },
        shapes: shapes,
        showlegend: true,
      };
      Plotly.newPlot('scatterPlot', scatterData.concat(boxData), layout);
    },

    /**
     * Updates the histogram chart with the fetched data.
     * Adds histogram data for selected scenarios and the AR6 data.
     * @param {Array} data - The data to be plotted.
     */
    updateHistogramChart(data) {
      const binsNumber = 32;
      let allHistogramData = [];

      data.forEach(item => {
        allHistogramData.push({
          x: item.data,
          type: 'histogram',
          name: item.scenario,
          xbins: {
            size: (Math.max(...item.data) - Math.min(...item.data)) / binsNumber
          },
          marker: {
            color: this.getScenarioColor(item.scenario),
            opacity: 0.5
          }
        });
      });

      // Add scenario data from ar6Data to the histogram
      Object.keys(this.ar6Data).forEach((key) => {
        const scenarioData = this.ar6Data[key];
        allHistogramData.push({
          x: scenarioData,
          type: 'histogram',
          name: key,
          xbins: {
            size: (Math.max(...scenarioData) - Math.min(...scenarioData)) / binsNumber
          },
          marker: {
            color: 'rgba(0,0,0,0)',  // Set to fully transparent
            opacity: 0  // Fully hidden
          },
          showlegend: false
        });
      });

      const histogramLayout = {
        title: 'Histogram of CO2 Storage Rates',
        barmode: 'overlay',
        xaxis: { title: 'CO2 Storage Rate (GtCO2/yr)' },
        yaxis: { title: 'Frequency' }
      };

      Plotly.newPlot('histogramChart', allHistogramData, histogramLayout);
    },

    /**
     * Returns the color associated with a given scenario.
     * @param {string} scenario - The scenario for which to get the color.
     * @returns {string} The color associated with the scenario.
     */
    getScenarioColor(scenario) {
      const colors = {
        'R_S1': '#5470C6', 'R_S2': '#91CC75', 'R_S3': '#EE6666',
        'R_S4': '#73C0DE', 'US1Gt': '#3BA272', 'EUUSChina': '#FC8452',
        '1.5\u2103:limited overshoot': '#9A60B4', '1.5\u2103:high overshoot': '#6E9E87', '2\u2103 > 67% likelihood': '#E98191', '2\u2103 > 50% likelihood': '#FFD92F',
        'All': '#9A60B4'
      };
      return colors[scenario] || '#ddd';
    }
  }
};
</script>

<style scoped>
#scatterPlot, #histogramChart {
  width: 100%;
  height: 100%;
}
.scenario-selection {
  box-shadow: 0 0 1.758vw 0 rgba(154, 143, 113, .2);
  padding: 20px;
  display: flex;
  justify-content: space-around;
}
</style>
